


<!DOCTYPE html>
<html lang="es">
<head>
  <title>Anulaci√≥n - Enteros</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --primary:#3f51b5;
      --secondary:#f50057;
      --accent:#00bcd4;
      --dark:#212121;
      --success:#2e7d32;
      --danger:#c62828;
      --text:#263238;
      --muted:#546e7a;

      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
    }

    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
    body{
      background:linear-gradient(135deg,#e3f2fd,#bbdefb);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      touch-action:manipulation;
      color:var(--text);
    }

    /* Fondo flotante */
    .floating-element{
      position:fixed;
      font-size:2rem;
      opacity:.08;
      z-index:-1;
      pointer-events:none;
      animation:floatElement 20s infinite ease-in-out;
    }
    @keyframes floatElement{
      0%,100%{transform:translate(0,0) rotate(0deg);opacity:.08}
      25%{transform:translate(16px,-12px) rotate(4deg);opacity:.12}
      50%{transform:translate(-12px,9px) rotate(-4deg);opacity:.10}
      75%{transform:translate(10px,16px) rotate(3deg);opacity:.12}
    }

    header{
      background:linear-gradient(135deg,var(--primary),var(--accent));
      color:#fff;
      padding:.55rem;
      text-align:center;
      box-shadow:0 2px 10px rgba(0,0,0,.2);
      width:100%;
      flex:0 0 auto;
    }
    .header-content{
      display:flex;
      justify-content:space-between;
      align-items:center;
      max-width:1400px;
      margin:0 auto;
    }

    /* Ni√±os: transici√≥n suave */
    .kid-pulse-wrap{
      position:relative;
      width:58px;height:46px;
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
    }
    .kid{
      position:absolute;inset:0;
      display:flex;align-items:center;justify-content:center;
      font-size:1.95rem;
      filter:drop-shadow(0 2px 3px rgba(0,0,0,.25));
      opacity:0;
      transform:scale(.65);
      will-change:transform, opacity;
    }
    .kid.boy{ animation:kidFadeCycle 12s infinite ease-in-out; }
    .kid.girl{ animation:kidFadeCycle 12s infinite ease-in-out; animation-delay:6s; }
    @keyframes kidFadeCycle{
      0% { opacity:0; transform:scale(.60) translateY(6px); }
      10% { opacity:1; transform:scale(1.08) translateY(0); }
      45% { opacity:1; transform:scale(1.08) translateY(0); }
      55% { opacity:.12; transform:scale(.75) translateY(7px); }
      60% { opacity:0; transform:scale(.55) translateY(10px); }
      100% { opacity:0; transform:scale(.55) translateY(10px); }
    }

    .logo{display:flex;align-items:center;justify-content:center;gap:.7rem;flex-wrap:wrap}
    .logo-icon{font-size:1.7rem;animation:pulse 2.2s infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
    h1{margin:0;font-size:1.32rem}
    .subtitle{font-size:.85rem;opacity:.95;margin:.15rem 0 0}

    /* Inicio */
    #inicio{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      width:100%;
      padding:.9rem;
      margin-top:.35rem;
      flex:1 1 auto;
    }
    .start-emoji{
      font-size:3.3rem;
      margin-bottom:12px;
      animation:pulse 2.8s infinite ease-in-out;
      display:flex;align-items:center;justify-content:center;
      line-height:1.05;
    }
    #nombre-input{
      font-size:18px;
      padding:12px;
      width:280px;
      margin:14px;
      border:2px solid var(--primary);
      border-radius:8px;
      text-align:center;
      box-shadow:0 2px 5px rgba(0,0,0,.1)
    }
    #comenzar-btn{
      padding:11px 24px;
      font-size:16px;
      background-color:var(--primary);
      color:#fff;
      border:none;
      border-radius:8px;
      cursor:pointer;
      transition:.3s;
      box-shadow:0 4px 6px rgba(0,0,0,.1)
    }
    #comenzar-btn:hover{
      background-color:#303f9f;
      transform:translateY(-2px);
      box-shadow:0 6px 8px rgba(0,0,0,.15)
    }
    .instruction-line{
      margin-top:44px;
      color:#0b2a66;
      font-weight:900;
      letter-spacing:.2px;
      font-size:1.08rem;
      font-family:"Trebuchet MS","Arial Rounded MT Bold","Segoe UI",sans-serif;
      text-shadow:0 1px 0 rgba(255,255,255,.55);
      text-align:center;
      max-width:720px;
      padding:0 10px;
    }

    /* Contenedor */
    #contenedor{
      display:none;
      flex-direction:row;
      align-items:stretch;
      padding:10px;
      width:98vw;
      max-width:none;
      margin:0 auto;
      gap:10px;
      flex:1 1 auto;
      min-height:0;
    }

    /* Paneles */
    #panel-izquierdo, #juego, #historial{
      background:#fff;
      padding:10px;
      border-radius:12px;
      box-shadow:0 4px 15px rgba(0,0,0,.1);
      text-align:center;
      min-height:0;
      overflow:hidden;
    }

    /* Laterales con scroll */
    #panel-izquierdo, #historial{ overflow:auto; }

    #panel-izquierdo{
      flex: 0 0 230px;
      border:3px solid var(--primary);
      display:flex;
      flex-direction:column;
    }

    /* IMPORTANTE: el centro por defecto sigue ocultando overflow en el juego */
    #juego{
      flex: 1 1 auto;
      border:3px solid var(--primary);
      display:flex;
      flex-direction:column;
      align-items:stretch;
      justify-content:stretch;
      position:relative;
      padding:10px;
      overflow:hidden; /* <-- para el juego */
      min-width: 520px;
    }

    /* ‚úÖ SOLO cuando haya certificado, permitimos scroll en el centro */
    #juego.showing-cert{
      overflow:auto;
      padding:8px;
    }

    #historial{
      flex: 0 0 345px;
      border:2px solid var(--accent);
      display:flex;
      flex-direction:column;
    }

    .info-panel{
      background:linear-gradient(135deg,#f5f5f5,#e0e0e0);
      padding:9px;border-radius:8px;margin:7px 0;border:1px solid #ddd;
      flex:0 0 auto;
    }
    .info-panel h3{margin:0 0 5px 0;color:var(--primary);font-size:1.02rem}
    .info-panel p{margin:5px 0;font-size:.9rem;color:#555}
    #temporizador-round{
      font-size:28px;color:var(--secondary);font-weight:900;text-shadow:1px 1px 2px rgba(0,0,0,.1)
    }
    #temporizador-total{
      font-size:17px;color:#455a64;font-weight:900
    }

    /* Campo */
    #playfield{
      flex:1 1 auto;
      min-height:0;
      width:100%;
      border-radius:14px;
      border:2px solid rgba(13,71,161,.20);
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.55), rgba(255,255,255,0) 55%),
        linear-gradient(135deg, #cfeaff, #bfe2ff);
      box-shadow:
        inset 0 0 0 2px rgba(63,81,181,.07),
        inset 0 0 38px rgba(13,71,161,.10),
        0 8px 20px rgba(0,0,0,.08);
      position:relative;
      overflow:hidden;
      opacity:1;
      transition:opacity .45s ease;
    }
    #playfield.fading{ opacity:0; }

    /* Orb */
    #target-orb{
      position:absolute;
      right:26px;
      top:50%;
      transform:translateY(-50%);
      width:150px;height:150px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:58px;
      color:#ffffff;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.22), rgba(255,255,255,0) 45%),
        radial-gradient(circle at 70% 75%, rgba(0,0,0,.30), rgba(0,0,0,0) 60%),
        linear-gradient(135deg, #061f3b, #08315f);
      border:3px solid rgba(255,255,255,.18);
      box-shadow:0 14px 30px rgba(0,0,0,.22);
      user-select:none;
      overflow:hidden;
    }

    .orb-goal{
      position:absolute;
      top:10px;
      left:50%;
      transform:translateX(-50%);
      font-size:22px;
      font-weight:900;
      letter-spacing:.5px;
      color:rgba(0,188,212,.28);
      text-shadow:0 2px 6px rgba(0,0,0,.35);
      pointer-events:none;
    }
    .orb-value{ line-height:1; }

    .orb-win{
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.35), rgba(255,255,255,0) 48%),
        radial-gradient(circle at 70% 75%, rgba(0,0,0,.22), rgba(0,0,0,0) 60%),
        linear-gradient(135deg, #1b8a3a, #0f6f2b);
      border-color:rgba(76,175,80,.55);
      box-shadow:0 14px 34px rgba(76,175,80,.20);
    }

    /* Feedback */
    #win-feedback{
      position:absolute;
      right:12px;
      top:calc(50% + 98px);
      transform:translateY(-50%);
      width:230px;
      text-align:center;
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease, transform .25s ease;
      filter:drop-shadow(0 2px 6px rgba(0,0,0,.12));
    }
    #win-feedback.show{
      opacity:1;
      transform:translateY(-50%) translateY(10px);
    }
    #win-feedback .win-emoji{ font-size:1.75rem; margin-bottom:4px; }
    #win-feedback .win-text{
      font-weight:950;
      color:#0f6f2b;
      font-size:1.08rem;
      letter-spacing:.2px;
      text-shadow:0 1px 0 rgba(255,255,255,.55);
    }
    .mini-confetti{
      position:absolute; inset:-10px 0 0 0;
      pointer-events:none; overflow:hidden;
    }
    .mini-piece{
      position:absolute; width:8px; height:12px; border-radius:3px;
      opacity:.95;
      animation:miniFall 1.1s linear infinite;
    }
    @keyframes miniFall{
      0%{ transform:translateY(-18px) rotate(0deg); }
      100%{ transform:translateY(120px) rotate(280deg); }
    }

    /* Globos */
    .globo{
      position:absolute;
      width:56px;height:56px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:19px;
      cursor:grab;
      background:
        radial-gradient(circle at 30% 25%, #ffffff, #ffd7dc 58%, #ffc0c8);
      color:#3a0f14;
      box-shadow:0 8px 18px rgba(0,0,0,.12), inset 0 2px 0 rgba(255,255,255,.75);
      border:2px solid rgba(245,0,87,.18);
      transition:transform .08s;
      touch-action:none;
    }
    .globo:active{cursor:grabbing;transform:scale(1.04)}

    /* Emojis esquinas */
    .corner-emoji{
      position:absolute;top:10px;font-size:1.9rem;opacity:.9;
      filter:drop-shadow(1px 2px 3px rgba(0,0,0,.2));
      transform:scale(1);
      transition:transform .25s, opacity .25s;
      pointer-events:none;
    }
    #emoji-left{left:10px}
    #emoji-right{right:10px}
    .emoji-pop{transform:scale(1.25) rotate(-6deg);opacity:1}
    #mensaje{ display:none; }

    /* Progreso */
    #bloques-progreso-container{
      display:flex;flex-wrap:wrap;gap:5px;padding:10px 0;
      min-height:60px;justify-content:center
    }
    .bloque-acierto{
      width:18px;height:18px;background:var(--success);
      border-radius:4px;box-shadow:inset 0 1px 3px rgba(0,0,0,.2);
      animation:aparecer-bloque .4s ease
    }
    @keyframes aparecer-bloque{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}

    /* Botones */
    .botones-container{margin-top:auto;display:flex;flex-direction:column;gap:10px}
    #terminar-btn, #reiniciar-btn, #barrer-btn{
      padding:10px 20px;font-size:16px;border:none;border-radius:8px;cursor:pointer;
      transition:.3s;color:#fff;box-shadow:0 3px 5px rgba(0,0,0,.1)
    }
    #terminar-btn{background:var(--secondary)}
    #terminar-btn:hover{background:#c51162;transform:translateY(-2px)}
    #reiniciar-btn{display:none;background:var(--primary)}
    #reiniciar-btn:hover{background:#303f9f;transform:translateY(-2px)}
    #barrer-btn{background:#6c757d}
    #barrer-btn:hover{background:#5a6268;transform:translateY(-2px)}

    /* Historial */
    #historial h2{font-size:1.25rem;margin-bottom:8px;color:var(--primary)}
    #historial table{width:100%;border-collapse:collapse;margin-top:8px;table-layout:fixed}
    #historial th,#historial td{border:1px solid #ddd;padding:7px;text-align:center;font-size:13px;word-break:break-word}
    #historial th{
      background:linear-gradient(135deg,#f8f9fa,#e9ecef);
      font-weight:bold;color:var(--primary)
    }
    .elite{background-color:#fff3e0;color:#e65100;font-weight:bold}
    .experto{background-color:#f3e5f5;color:#7b1fa2;font-weight:bold}
    .competente{background-color:#e3f2fd;color:#1565c0;font-weight:bold}
    .iniciado{background-color:#ffebee;color:#c62828;font-weight:bold}

    footer{
      text-align:center;
      padding: 2.25rem 0;
      background:var(--dark);
      color:#fff;
      width:100%;
      flex:0 0 auto;
    }
    footer p{margin:.25rem 0;font-size:.8rem}

    /* ==========================
       ‚úÖ CERTIFICADO (COMPACTO)
       - subido
       - menos padding
       - menos interlineado
       - tipograf√≠a un poco menor
       - max-height para no cortarse
    =========================== */
    .cert-wrap{
      height:100%;
      display:flex;
      align-items:flex-start;         /* ‚úÖ sube el certificado */
      justify-content:center;
      padding:6px;                    /* ‚úÖ menos margen externo */
    }
    .cert{
      width:min(720px, 96%);
      background:#fff;
      border-radius:14px;
      border:2px solid rgba(63,81,181,0.25);
      box-shadow:0 10px 22px rgba(0,0,0,0.10);
      padding:18px 16px;              /* ‚úÖ m√°s compacto */
      text-align:center;
      line-height:1.22;               /* ‚úÖ menos interlineado */
      max-height:100%;                /* ‚úÖ no excede el contenedor */
    }
    .cert-badge{
      font-size:1.7rem;               /* ‚úÖ m√°s peque√±o */
      margin-bottom:6px;
    }
    .cert-title{
      margin:0;
      color:var(--primary);
      font-size:1.45rem;              /* ‚úÖ menos grande */
      letter-spacing:.3px;
      font-weight:900;
    }
    .cert-subtitle{
      margin:10px 0 4px;
      font-size:.95rem;
      color:#444;
    }
    .cert-game{
      margin:0 0 12px;
      font-size:1.02rem;
      color:#283593;
      font-weight:700;
      font-style:italic;
    }
    .cert-award{
      font-size:.95rem;
      margin:0 0 6px;
      color:#333;
    }
    .cert-name{
      margin:4px 0 10px;
      font-size:1.55rem;              /* ‚úÖ m√°s peque√±o */
      color:#1a237e;
      font-weight:900;
      letter-spacing:.3px;
    }
    .cert-msg{
      margin:6px 0 10px;
      font-size:1.0rem;               /* ‚úÖ compactado */
      font-weight:600;
      color:#424242;
    }
    .cert-stats{
      margin:6px 0;
      font-size:.98rem;
      color:#333;
    }
    .cert-rank{
      color:#d50000;
      font-weight:900;
    }
    .cert-date{
      margin-top:8px;
      color:#555;
      font-size:.9rem;
    }
    .cert-footer{
      margin-top:12px;
      padding-top:10px;
      border-top:1px solid #ddd;
      font-size:.9rem;
      color:#555;
      line-height:1.22;
    }

    /* Responsive */
    @media (max-width:1024px){
      #contenedor{flex-direction:column;width:98vw;padding:10px}
      #panel-izquierdo,#juego,#historial{width:100%;flex:auto}
      #juego{min-width:unset;}
      #playfield{height:385px}
      #target-orb{right:16px;width:138px;height:138px;font-size:52px}
      #win-feedback{right:12px;width:260px;}
    }
    @media (max-width:480px){
      #playfield{height:360px}
      #target-orb{right:12px;width:128px;height:128px;font-size:48px}
      .globo{width:54px;height:54px;font-size:18px}
      .cert{padding:16px 12px}
      .cert-title{font-size:1.28rem}
      .cert-name{font-size:1.45rem}
    }
  </style>
</head>

<body>
  <div class="floating-element" style="top:5%; left:3%; animation-delay:0s;">üî¢</div>
  <div class="floating-element" style="top:18%; right:5%; animation-delay:1s;">üéØ</div>
  <div class="floating-element" style="top:30%; left:8%; animation-delay:2s;">ü©π</div>
  <div class="floating-element" style="top:40%; right:10%; animation-delay:3s;">‚ú®</div>
  <div class="floating-element" style="top:55%; left:5%; animation-delay:4s;">üß†</div>

  <header>
    <div class="header-content">
      <div class="kid-pulse-wrap" aria-hidden="true">
        <div class="kid boy">üë¶</div>
        <div class="kid girl">üëß</div>
      </div>

      <div class="logo">
        <span class="logo-icon">‚ûñ</span>
        <h1>Anulaci√≥n (Enteros)</h1>
        <span class="logo-icon">‚ûï</span>
      </div>

      <div class="kid-pulse-wrap" aria-hidden="true">
        <div class="kid boy">üë¶</div>
        <div class="kid girl">üëß</div>
      </div>
    </div>
    <p class="subtitle">Profesores: Miguel Ubiera y Anna Mor√°n</p>
  </header>

  <main style="flex:1 1 auto; display:flex; flex-direction:column;">
    <div id="inicio">
      <div class="start-emoji" aria-hidden="true">üéØ üßè üéØ</div>
      <h2 style="margin-bottom: 10px; color: var(--primary);">Escribe tu nombre</h2>
      <input type="text" id="nombre-input" placeholder="Tu nombre aqu√≠" autofocus aria-label="Nombre del participante" />
      <button id="comenzar-btn" type="button">Comenzar</button>
      <div class="instruction-line">Arroja los globos hasta obtener un -20 o +20.</div>
    </div>

    <div id="contenedor">
      <aside id="panel-izquierdo">
        <div class="info-panel">
          <h3>‚è±Ô∏è Round (20 s)</h3>
          <div id="temporizador-round">20</div>
        </div>

        <div class="info-panel">
          <h3>‚åõ Sesi√≥n</h3>
          <div id="temporizador-total">200 segundos</div>
        </div>

        <div class="info-panel">
          <h3>üìà Rendimiento</h3>
          <p><strong>Aciertos:</strong> <span id="aciertos">0</span></p>
        </div>

        <div class="info-panel">
          <h3>üß± Progreso</h3>
          <div id="bloques-progreso-container"></div>
        </div>

        <div class="botones-container">
          <button id="terminar-btn" type="button">Terminar Partida</button>
          <button id="reiniciar-btn" type="button">Jugar de Nuevo</button>
        </div>
      </aside>

      <section id="juego">
        <div id="playfield" aria-label="Campo de juego">
          <div id="target-orb" aria-label="Globo objetivo">
            <div class="orb-goal" id="orb-goal">+20</div>
            <div class="orb-value" id="orb-value">-12</div>
          </div>

          <div id="win-feedback" aria-live="polite">
            <div class="mini-confetti" aria-hidden="true"></div>
            <div class="win-emoji">üéâ‚úÖ</div>
            <div class="win-text" id="win-text">¬°Felicidades!</div>
          </div>

          <div id="emoji-left" class="corner-emoji">üë¶</div>
          <div id="emoji-right" class="corner-emoji">üëß</div>
        </div>
        <div id="mensaje"></div>
      </section>

      <aside id="historial">
        <h2>üèÜ Historial</h2>
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Aciertos</th>
              <th>Jerarqu√≠a</th>
            </tr>
          </thead>
          <tbody id="lista-historial"></tbody>
        </table>

        <div style="margin-top:auto;padding-top:10px;">
          <button id="barrer-btn" type="button">Barrer Historial</button>
        </div>
      </aside>
    </div>
  </main>

  <footer>
    <p>Instituto para Sordos Santa Rosa, Inc.</p>
    <p>¬© 2025 - Desarrollado por Miguel Ubiera y Anna Mor√°n</p>
  </footer>

  <script>
    "use strict";

    /* =========================
        ANULACI√ìN (Enteros)
    ========================= */

    const ROUND_SECONDS = 20;
    const SESSION_SECONDS = 200;

    const R = 28;
    const FRICTION = 0.995;
    const MAX_SPEED = 10;
    const LAUNCH_SPEED = 1800;

    const N_GLOBOS = 20;
    const LOCAL_BOUND = 28;

    const MENSAJES_OK = ["¬°Felicidades!", "¬°Muy bien!", "¬°Sigue adelante!"];

    let nombreParticipante = "";
    let aciertos = 0;

    let tiempoTotal = SESSION_SECONDS;
    let tiempoRound = ROUND_SECONDS;

    let timerTotal = null;
    let timerRound = null;

    let running = false;
    let roundLocked = false;

    let historial = JSON.parse(localStorage.getItem("historialAnulacion")) || [];

    let globos = [];
    let rafId = null;
    let lastTs = 0;

    let globoId = 0;
    let activePointer = null;

    let idxOk = 0;

    let bigValue = -12;
    let goalValue = 20;

    let posCount = 0;
    let negCount = 0;

    const $ = (id) => document.getElementById(id);

    const inicio = $("inicio");
    const contenedor = $("contenedor");

    const inputNombre = $("nombre-input");
    const btnComenzar = $("comenzar-btn");
    const btnTerminar = $("terminar-btn");
    const btnReiniciar = $("reiniciar-btn");
    const btnBarrer = $("barrer-btn");

    const juegoSection = $("juego");

    const playfield = $("playfield");
    const targetOrb = $("target-orb");
    const orbGoalEl = $("orb-goal");
    const orbValueEl = $("orb-value");

    const winFeedback = $("win-feedback");
    const miniConfettiLayer = winFeedback.querySelector(".mini-confetti");
    const winText = $("win-text");

    const emojiLeft = $("emoji-left");
    const emojiRight = $("emoji-right");

    const tRoundEl = $("temporizador-round");
    const tTotalEl = $("temporizador-total");
    const aciertosEl = $("aciertos");
    const progresoEl = $("bloques-progreso-container");
    const listaHistorial = $("lista-historial");

    function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function randFloat(min,max){ return Math.random()*(max-min)+min; }

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
    }

    function fmt(n){
      if(n === 0) return "0";
      return n > 0 ? `+${n}` : `${n}`;
    }

    function escapeHTML(str){
      return String(str).replace(/[&<>"'`=\/]/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",
        "\"":"&quot;","'":"&#39;","`":"&#96;",
        "=":"&#61;","/":"&#47;"
      }[s]));
    }

    function siguienteMensajeOK(){
      const msg = MENSAJES_OK[idxOk % MENSAJES_OK.length];
      idxOk++;
      return msg;
    }

    function updateUIStats(){
      aciertosEl.textContent = String(aciertos);
      tTotalEl.textContent = `${tiempoTotal} segundos`;
      tRoundEl.textContent = String(tiempoRound);
    }

    function obtenerJerarquia(p){
      if(p < 6) return "Iniciado";
      if(p >= 6 && p <= 10) return "Competente";
      if(p >= 11 && p <= 15) return "Experto";
      return "√âlite";
    }

    function fraseDesempeno(a){
      const j = obtenerJerarquia(a);
      if(j === "√âlite") return "Excelente. Evidencia un dominio notable de la anulaci√≥n de enteros.";
      if(j === "Experto") return "Muy buen desempe√±o. Su estrategia fue precisa y consistente.";
      if(j === "Competente") return "Buen avance. Contin√∫e fortaleciendo su habilidad con pr√°ctica.";
      return "Buen inicio. Siga practicando para mejorar su rendimiento.";
    }

    function actualizarHistorial(){
      listaHistorial.textContent = "";
      for(const p of historial){
        const tr = document.createElement("tr");

        const tdNombre = document.createElement("td");
        tdNombre.textContent = p.nombre;

        const tdAciertos = document.createElement("td");
        tdAciertos.textContent = String(p.aciertos);

        const tdJerarquia = document.createElement("td");
        tdJerarquia.textContent = p.jerarquia;
        tdJerarquia.className = p.jerarquia.toLowerCase();

        tr.appendChild(tdNombre);
        tr.appendChild(tdAciertos);
        tr.appendChild(tdJerarquia);
        listaHistorial.appendChild(tr);
      }
    }

    function barrerHistorial(){
      if(confirm("¬øEst√°s seguro de que quieres borrar todo el historial?")){
        historial = [];
        localStorage.removeItem("historialAnulacion");
        actualizarHistorial();
      }
    }

    function iniciarJuego(){
      const rawName = inputNombre.value.trim();
      if(!rawName){
        alert("Por favor, escribe tu nombre.");
        return;
      }
      nombreParticipante = rawName;

      inicio.style.display = "none";
      contenedor.style.display = "flex";

      aciertos = 0;
      tiempoTotal = SESSION_SECONDS;
      updateUIStats();

      btnReiniciar.style.display = "none";
      btnTerminar.style.display = "block";
      progresoEl.textContent = "";

      running = true;

      clearInterval(timerTotal);
      timerTotal = setInterval(() => {
        if(!running) return;
        tiempoTotal--;
        tTotalEl.textContent = `${tiempoTotal} segundos`;
        if(tiempoTotal <= 0) terminarPartida();
      }, 1000);

      iniciarNuevoRound(true);
    }

    function terminarPartida(){
      running = false;

      clearInterval(timerTotal);
      clearInterval(timerRound);
      cancelAnimationFrame(rafId);

      const jerarquia = obtenerJerarquia(aciertos);

      historial.push({
        nombre: nombreParticipante,
        aciertos,
        jerarquia,
        fecha: new Date().toLocaleDateString("es-ES")
      });

      historial.sort((a,b) => b.aciertos - a.aciertos);
      localStorage.setItem("historialAnulacion", JSON.stringify(historial));
      actualizarHistorial();

      // ‚úÖ Activar modo certificado (scroll permitido solo aqu√≠)
      juegoSection.classList.add("showing-cert");

      const safeName = escapeHTML(nombreParticipante);

      juegoSection.innerHTML = `
        <div class="cert-wrap">
          <div class="cert" role="group" aria-label="Certificado de reconocimiento">
            <div class="cert-badge">üéì‚ú®</div>
            <h2 class="cert-title">CERTIFICADO DE RECONOCIMIENTO</h2>

            <p class="cert-subtitle">Otorgado por su desempe√±o en:</p>
            <div class="cert-game">Anulaci√≥n de Enteros</div>

            <p class="cert-award">Se concede a:</p>
            <div class="cert-name">${safeName}</div>

            <div class="cert-msg">${fraseDesempeno(aciertos)}</div>

            <div class="cert-stats">
              <b>Aciertos:</b> ${aciertos}
              &nbsp;‚Ä¢&nbsp;
              <b>Jerarqu√≠a:</b>
              <span class="cert-rank">${jerarquia}</span>
            </div>

            <div class="cert-date">
              Fecha de emisi√≥n: <b>${new Date().toLocaleDateString("es-ES")}</b>
            </div>

            <div class="cert-footer">
              Profesores responsables:<br>
              <b>Miguel Ubiera</b> y <b>Anna Mor√°n</b>
            </div>
          </div>
        </div>
      `;

      btnReiniciar.style.display = "block";
      btnTerminar.style.display = "none";
    }

    function reiniciarJuego(){
      window.location.reload();
    }

    function iniciarNuevoRound(isFirst=false){
      if(!running) return;

      roundLocked = false;
      hideWinFeedback();

      const doStart = () => {
        tiempoRound = ROUND_SECONDS;
        tRoundEl.textContent = String(tiempoRound);

        goalValue = (Math.random() < 0.5) ? -20 : 20;
        orbGoalEl.textContent = fmt(goalValue);

        bigValue = randInt(-19, 19);
        renderBigValue();

        limpiarGlobos();

        const values = generarGlobosBalanceadosConSolucion(bigValue, N_GLOBOS, goalValue);

        const rect = playfield.getBoundingClientRect();
        const W = rect.width, H = rect.height;
        const xLeftMax = Math.floor(W * 0.62);

        const xMin = R + 12;
        const xMax = xLeftMax - R - 12;
        const yMin = R + 12;
        const yMax = H - R - 12;

        values.forEach((v) => {
          const hx = randFloat(xMin, xMax);
          const hy = randFloat(yMin, yMax);
          const vx = randFloat(-MAX_SPEED, MAX_SPEED);
          const vy = randFloat(-MAX_SPEED, MAX_SPEED);
          crearGlobo(v, hx, hy, vx, vy, hx, hy);
        });

        clearInterval(timerRound);
        timerRound = setInterval(() => {
          if(!running) return;
          tiempoRound--;
          tRoundEl.textContent = String(tiempoRound);
          if(tiempoRound <= 0){
            clearInterval(timerRound);
            iniciarNuevoRound();
          }
        }, 1000);

        lastTs = performance.now();
        cancelAnimationFrame(rafId);
        rafId = requestAnimationFrame(loop);
      };

      if(isFirst){ doStart(); return; }

      playfield.classList.add("fading");
      setTimeout(() => {
        doStart();
        playfield.classList.remove("fading");
      }, 420);
    }

    function loop(ts){
      if(!running) return;
      const dt = Math.min(0.033, (ts - lastTs)/1000);
      lastTs = ts;
      actualizarFisica(dt);
      rafId = requestAnimationFrame(loop);
    }

    function actualizarFisica(dt){
      const rect = playfield.getBoundingClientRect();
      const W = rect.width, H = rect.height;
      const xLeftMax = Math.floor(W * 0.62);

      for(const g of globos){
        if(g.state === "held") continue;

        g.x += g.vx * dt;
        g.y += g.vy * dt;
        g.vx *= FRICTION;
        g.vy *= FRICTION;

        if(g.state === "float"){
          const minX = Math.max(R, g.homeX - LOCAL_BOUND);
          const maxX = Math.min(xLeftMax - R, g.homeX + LOCAL_BOUND);
          const minY = Math.max(R, g.homeY - LOCAL_BOUND);
          const maxY = Math.min(H - R, g.homeY + LOCAL_BOUND);

          if(g.x < minX){ g.x = minX; g.vx = Math.abs(g.vx) * 0.9; }
          if(g.x > maxX){ g.x = maxX; g.vx = -Math.abs(g.vx) * 0.9; }
          if(g.y < minY){ g.y = minY; g.vy = Math.abs(g.vy) * 0.9; }
          if(g.y > maxY){ g.y = maxY; g.vy = -Math.abs(g.vy) * 0.9; }
        } else if(g.state === "launch"){
          if(g.y - R < 0){ g.y = R; g.vy = Math.abs(g.vy); }
          if(g.y + R > H){ g.y = H - R; g.vy = -Math.abs(g.vy); }
        }
      }

      const floaters = globos.filter(g => g.state === "float" || g.state === "held");
      for(let i=0;i<floaters.length;i++){
        for(let j=i+1;j<floaters.length;j++){
          resolveCircleCollision(floaters[i], floaters[j]);
        }
      }

      const t = targetOrb.getBoundingClientRect();
      const pf = playfield.getBoundingClientRect();
      const tx = (t.left - pf.left) + t.width/2;
      const ty = (t.top - pf.top) + t.height/2;
      const targetRadius = t.width * 0.44;

      for(const g of [...globos]){
        if(g.state !== "launch") continue;

        const dx = g.x - tx;
        const dy = g.y - ty;
        const dist = Math.hypot(dx, dy);

        if(dist < targetRadius + R * 0.75){
          const repX = g.homeX, repY = g.homeY;

          burstAt(tx, ty);
          efectoImpacto();

          bigValue += g.value;
          renderBigValue();
          showOrbDelta(g.value);

          eliminarGlobo(g.id);

          let sign;
          if(posCount < negCount) sign = +1;
          else if(negCount < posCount) sign = -1;
          else sign = Math.random() < 0.5 ? +1 : -1;

          const nuevo = sign * randInt(1,3);

          const vx = randFloat(-MAX_SPEED, MAX_SPEED);
          const vy = randFloat(-MAX_SPEED, MAX_SPEED);
          crearGlobo(nuevo, repX, repY, vx, vy, repX, repY);

          if(bigValue === goalValue && !roundLocked){
            roundLocked = true;
            aciertos++;
            updateUIStats();
            registrarAciertoVisual();
            efectoAcierto();
            showWinFeedback();
            clearInterval(timerRound);
            setTimeout(() => iniciarNuevoRound(), 1100);
          }
        }
      }

      for(const g of globos){
        g.el.style.transform = `translate(${g.x - R}px, ${g.y - R}px)`;
      }
    }

    function resolveCircleCollision(a,b){
      const dx = b.x - a.x;
      const dy = b.y - a.y;
      const dist = Math.hypot(dx, dy);
      const minDist = R*2 + 2;
      if(dist === 0 || dist >= minDist) return false;

      const overlap = (minDist - dist);
      const nx = dx / dist;
      const ny = dy / dist;

      const aHeld = (a.state === "held");
      const bHeld = (b.state === "held");

      if(aHeld && !bHeld){
        b.x += nx * overlap;
        b.y += ny * overlap;
      } else if(bHeld && !aHeld){
        a.x -= nx * overlap;
        a.y -= ny * overlap;
      } else {
        a.x -= nx * overlap/2;
        a.y -= ny * overlap/2;
        b.x += nx * overlap/2;
        b.y += ny * overlap/2;
      }

      a.vx *= 0.96; a.vy *= 0.96;
      b.vx *= 0.96; b.vy *= 0.96;
      return true;
    }

    function burstAt(x,y){
      const p = document.createElement("div");
      p.style.position = "absolute";
      p.style.left = x + "px";
      p.style.top = y + "px";
      p.style.width = "44px";
      p.style.height = "44px";
      p.style.borderRadius = "50%";
      p.style.background = "rgba(255,255,255,0.75)";
      p.style.boxShadow = "0 0 28px rgba(255,255,255,0.95)";
      p.style.transform = "translate(-50%, -50%) scale(1)";
      p.style.opacity = "1";
      p.style.pointerEvents = "none";
      p.style.transition = "transform 0.22s ease-out, opacity 0.22s ease-out";
      playfield.appendChild(p);

      requestAnimationFrame(() => {
        p.style.transform = "translate(-50%, -50%) scale(2.1)";
        p.style.opacity = "0";
      });

      setTimeout(() => p.remove(), 260);
    }

    function registrarAciertoVisual(){
      const b = document.createElement("div");
      b.className = "bloque-acierto";
      progresoEl.appendChild(b);
    }

    function efectoImpacto(){
      emojiRight.textContent = "üí•";
      emojiRight.classList.add("emoji-pop");
      setTimeout(() => {
        emojiRight.classList.remove("emoji-pop");
        emojiRight.textContent = "üéØ";
      }, 330);
    }

    function efectoAcierto(){
      emojiLeft.textContent = "‚úÖ";
      emojiLeft.classList.add("emoji-pop");
      setTimeout(() => {
        emojiLeft.classList.remove("emoji-pop");
        emojiLeft.textContent = "üß†";
      }, 560);
    }

    function showWinFeedback(){
      targetOrb.classList.add("orb-win");
      orbValueEl.textContent = fmt(goalValue);

      winText.textContent = siguienteMensajeOK();
      miniConfettiLayer.textContent = "";

      const colors = ["#ff5252","#ffeb3b","#69f0ae","#40c4ff","#b388ff","#ff9800"];
      for(let i=0;i<18;i++){
        const piece = document.createElement("div");
        piece.className = "mini-piece";
        piece.style.left = (Math.random()*100) + "%";
        piece.style.background = colors[Math.floor(Math.random()*colors.length)];
        piece.style.animationDelay = (Math.random()*0.35) + "s";
        piece.style.animationDuration = (0.85 + Math.random()*0.55) + "s";
        miniConfettiLayer.appendChild(piece);
      }

      winFeedback.classList.add("show");
      setTimeout(hideWinFeedback, 1000);
    }

    function hideWinFeedback(){
      winFeedback.classList.remove("show");
      miniConfettiLayer.textContent = "";
    }

    function showOrbDelta(val){
      const badge = document.createElement("div");
      badge.textContent = fmt(val);
      badge.style.position = "absolute";

      const t = targetOrb.getBoundingClientRect();
      const pf = playfield.getBoundingClientRect();

      badge.style.left = ((t.left - pf.left) + t.width/2) + "px";
      badge.style.top  = ((t.top  - pf.top ) + t.height/2 - 10) + "px";
      badge.style.transform = "translate(-50%, -50%)";
      badge.style.fontWeight = "900";
      badge.style.fontSize = "22px";
      badge.style.color = (val > 0) ? "#2e7d32" : "#c62828";
      badge.style.textShadow = "0 1px 2px rgba(0,0,0,.35)";
      badge.style.pointerEvents = "none";
      badge.style.transition = "transform .45s ease-out, opacity .45s ease-out";
      badge.style.opacity = "1";

      playfield.appendChild(badge);

      requestAnimationFrame(() => {
        badge.style.transform = "translate(-50%, -95%)";
        badge.style.opacity = "0";
      });

      setTimeout(() => badge.remove(), 520);
    }

    function renderBigValue(){
      orbValueEl.textContent = fmt(bigValue);
      targetOrb.classList.remove("orb-win");
    }

    function getTargetCenterInPlayfield(){
      const t = targetOrb.getBoundingClientRect();
      const pf = playfield.getBoundingClientRect();
      return { x:(t.left - pf.left) + t.width/2, y:(t.top - pf.top) + t.height/2 };
    }

    function crearGlobo(value, x, y, vx, vy, homeX, homeY){
      const el = document.createElement("div");
      el.className = "globo";
      el.textContent = fmt(value);
      el.tabIndex = 0;

      playfield.appendChild(el);

      const g = {
        id: ++globoId,
        value, x, y, vx, vy,
        el,
        state:"float",
        offsetX:0, offsetY:0,
        homeX, homeY
      };

      if(value > 0) posCount++;
      else if(value < 0) negCount++;

      el.addEventListener("pointerdown", (e) => {
        if(!running) return;
        if(activePointer !== null) return;

        activePointer = e.pointerId;
        el.setPointerCapture(e.pointerId);

        g.state = "held";

        const rect = playfield.getBoundingClientRect();
        g.offsetX = (e.clientX - rect.left) - g.x;
        g.offsetY = (e.clientY - rect.top) - g.y;

        g.vx = 0; g.vy = 0;
      });

      el.addEventListener("pointermove", (e) => {
        if(activePointer !== e.pointerId) return;
        const rect = playfield.getBoundingClientRect();
        g.x = (e.clientX - rect.left) - g.offsetX;
        g.y = (e.clientY - rect.top) - g.offsetY;
      });

      el.addEventListener("pointerup", (e) => {
        if(activePointer !== e.pointerId) return;
        activePointer = null;

        if(roundLocked){ g.state = "float"; return; }

        const c = getTargetCenterInPlayfield();
        const dx = c.x - g.x;
        const dy = c.y - g.y;
        const d = Math.hypot(dx,dy) || 1;

        g.vx = (dx/d) * LAUNCH_SPEED;
        g.vy = (dy/d) * LAUNCH_SPEED;
        g.state = "launch";
      });

      globos.push(g);
    }

    function eliminarGlobo(id){
      const idx = globos.findIndex(g => g.id === id);
      if(idx >= 0){
        const v = globos[idx].value;
        if(v > 0) posCount = Math.max(0, posCount - 1);
        else if(v < 0) negCount = Math.max(0, negCount - 1);

        globos[idx].el.remove();
        globos.splice(idx,1);
      }
    }

    function limpiarGlobos(){
      for(const g of globos) g.el.remove();
      globos = [];
      activePointer = null;
      posCount = 0;
      negCount = 0;
    }

    function generarGlobosBalanceadosConSolucion(bigValue, N, goalValue){
      const target = goalValue - bigValue;

      const POS_TARGET = Math.floor(N/2);
      const NEG_TARGET = N - POS_TARGET;

      let pos = 0, neg = 0;

      let safetyAll = 0;
      while(safetyAll++ < 400){
        const tmp = [];
        let partial = 0;
        pos = 0; neg = 0;

        const k = randInt(2,4);

        for(let i=0; i<k-1; i++){
          let sign;
          if(pos >= POS_TARGET) sign = -1;
          else if(neg >= NEG_TARGET) sign = +1;
          else sign = (Math.random() < 0.5 ? +1 : -1);

          const mag = randInt(1,3);
          const v = sign * mag;
          tmp.push(v);
          partial += v;
          if(sign > 0) pos++; else neg++;
        }

        const last = target - partial;

        if(last !== 0 && Math.abs(last) <= 3){
          const signLast = Math.sign(last);

          if((signLast > 0 && pos < POS_TARGET) || (signLast < 0 && neg < NEG_TARGET)){
            tmp.push(last);
            if(signLast > 0) pos++; else neg++;

            const restantes = N - tmp.length;
            const toAddPos = POS_TARGET - pos;
            const toAddNeg = NEG_TARGET - neg;

            if(toAddPos >= 0 && toAddNeg >= 0 && (toAddPos + toAddNeg === restantes)){
              for(let i=0;i<toAddPos;i++) tmp.push(+randInt(1,3));
              for(let i=0;i<toAddNeg;i++) tmp.push(-randInt(1,3));
              shuffle(tmp);
              return tmp;
            }
          }
        }
      }

      const tmp = [];
      pos = 0; neg = 0;
      let remaining = target;

      while(remaining !== 0 && tmp.length < N){
        let stepMag = Math.min(3, Math.abs(remaining));
        let stepSign = remaining > 0 ? +1 : -1;

        if(stepSign > 0 && pos >= POS_TARGET) stepSign = -1;
        if(stepSign < 0 && neg >= NEG_TARGET) stepSign = +1;

        if(stepSign > 0 && pos >= POS_TARGET) break;
        if(stepSign < 0 && neg >= NEG_TARGET) break;

        const v = stepSign * stepMag;
        tmp.push(v);
        remaining -= v;

        if(v > 0) pos++;
        else neg++;
      }

      while(tmp.length < N && pos < POS_TARGET){ tmp.push(+randInt(1,3)); pos++; }
      while(tmp.length < N && neg < NEG_TARGET){ tmp.push(-randInt(1,3)); neg++; }

      shuffle(tmp);
      return tmp;
    }

    btnComenzar.addEventListener("click", iniciarJuego);
    btnTerminar.addEventListener("click", terminarPartida);
    btnReiniciar.addEventListener("click", reiniciarJuego);
    btnBarrer.addEventListener("click", barrerHistorial);

    inputNombre.addEventListener("keydown", (e) => {
      if(e.key === "Enter") iniciarJuego();
    });

    actualizarHistorial();
  </script>
</body>
</html>
